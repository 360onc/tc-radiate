<!DOCTYPE html>
<html>
    <head>
        <meta name="viewport" content="width=device-width" />
        <title>Builds</title>
		<link href="Content/Style.css" rel="stylesheet" />
    </head>
<body>
	<div class="page-loading" data-bind="showHide: isFirstLoad() && !builds().length"></div>
	<div class="page-content" data-bind="showHide: !isFirstLoad() || builds().length">
	    <div id="left-panel">
	        <ul data-bind="foreach: { data: builds }">
	            <li data-bind="attr: { class: lowerStatus() }, css: { running: isRunning() },
                        event: {
                            contextmenu: function () {
                                if (confirm('Are you sure you want to stop monitoring this branch?\n(Right click on the big picture to show them all again)'))
                                    $root.excludedBuilds.push($data);
                            }
                        }">
	                <div class="build-project"><span data-bind="text: buildType().projectName"></span> >
	                </div>
	                <div class="build-type" data-bind="text: buildType"></div>
                    <!-- ko if: $data.branchName -->
	                    <div class="build-branch"> > <i class="build-branch-name" data-bind="text: branchName"></i> branch</div>
                    <!-- /ko -->
                    <div class="build-number">#<span data-bind="text: number"></span> </div>
	                <div class="clear"></div>
	                <div class="build-status" data-bind="text: isRunning() ? '' : status"></div>
	                <div class="clear"></div>
	                <!-- ko if: hasProgress() -->
                       <div class="progress-container" data-bind="attr: { 'data-progress' : percentageComplete() }"></div>
                    <!-- /ko -->
	            </li>
	        </ul>
	    </div>
	    <div id="right-panel" data-bind="event: {
                            contextmenu: function () {
                                if ($root.excludedBuilds.length && confirm('Are you sure you want to show all excluded branches?\n(Right click on a build to exclude it again)'))
                                    $root.excludedBuilds.removeAll();
                            }
                        }">
            <div class="page-loading" data-bind="showHide: isFirstLoad()"></div>
	        <!-- ko with: mainBuild -->
	        <div id="main-build" data-bind="css: lowerStatus">
	            <img data-bind="
                    attr: { src: $root.getImageForStatus(lowerStatus()) },
                    event: {
                        error: function () {
                            console.error({ message: 'Possibly need to change a link to an image. Falling back to a different image because of an error trying to display ' + $element.src, errorEventArgs: arguments });
                            $element.src = ''; $element.src = $root.getImageForStatus(lowerStatus())();
                        }
                    }
                    " style="max-height: 60%; bottom: 0; position: absolute; margin-left: auto; margin-right: auto; left: 0; right: 0;"/>
                <div style="position: absolute; margin-left: auto; margin-right: auto; left: 0; right: 0;">
                    <div id="main-branch-status" class="highlight" data-bind="text: status"></div>
                    <!-- ko if: Settings.mainBranch || status() !== 'SUCCESS' -->
                    <audio controls data-bind="
                        attr: { autoplay: isNew },
                        afterHtmlRender: function () {
                            var soundInfo = Sounds.Failures.getRandom();
                            if (soundInfo.time) {
                                if (soundInfo.time.startSecond)
                                    $element.addEventListener('canplaythrough', function() {
                                        if (soundInfo.url !== this.src)
                                            return;
                                        if (this.currentTime < soundInfo.time.startSecond)
                                            this.currentTime = soundInfo.time.startSecond;
                                      });
                                if (soundInfo.time.endSecond)
                                    $element.addEventListener('timeupdate', function() {
                                        if (soundInfo.url !== this.src)
                                            return;
                                        if (this.currentTime > soundInfo.time.endSecond) {
                                            this.currentTime = 0;
                                            this.pause();
                                        }
                                      });
                            }
                            $element.src = soundInfo.url;
                            $element.volume = $root.audio.volume();
                            $element.muted = $root.audio.isMuted();
                        },
                        event: {
                            volumechange: function () { $root.audio.volume($element.volume); $root.audio.isMuted($element.muted); },
                            error: function () {
                                console.error({ message: 'Possibly need to change link to a sound. Falling back to a local sound because of an error trying to play ' + $element.src, errorEventArgs: arguments });
                                $element.src = Sounds.Failures.getRandomLocal().url;
                            }
                        },
                    "></audio>
                    <div id="main-branch-name">
                        <span class="build-project" data-bind="text: buildType.projectName"></span> > <span class="build-type" data-bind="text: buildType.name"></span> >
                        <!-- ko if: $data.branchName -->
                        <span class="build-branch"><i class="build-branch-name" data-bind="text: branchName"></i> branch</span> >
                        <!-- /ko -->
                        Build <span class="build-number" class="highlight" data-bind="text: number"></span>
                    </div>
                    <div id="main-branch-investigated-by" data-bind="with: $data.investigations">
                        <!-- ko if: length -->
                        Investigated by
                        <ul class="inlineSentenceList" data-bind="foreach: $data">
                            <!-- ko if: assignee.name -->
                            <li><span class="highlight" data-bind="text: assignee.name"></span></li>
                            <!-- /ko -->
                        </ul>
                        <!-- /ko -->
                    </div>
                    <div id="main-branch-changed-by" data-bind="with: _($data.changes()).uniq(function (c) { return c.username; })">
                        <!-- ko if: length -->
                        Last changes by
                        <ul class="inlineSentenceList" data-bind="foreach: $data">
                            <!-- ko if: username -->
                            <li><a class="highlight" data-bind="text: username"></a></li>
                            <!-- /ko -->
                        </ul>
                        <!-- /ko -->
                    </div>
                    <div id="main-branch-triggered-by" data-bind="if: !$data.lastChanges && $data.triggeredBy">
                        Triggered by <a class="highlight" data-bind="text: triggeredBy, attr: { href: webUrl }"></a>
                    </div>
                    <!-- /ko -->
                </div>
	        </div>
	        <!-- /ko -->
	    </div>

	</div>
    <div class="error-box" data-bind="showHide: hasError">
        <div data-bind="text: errorMessage"></div>
    </div>

    <script src="Script/Libraries/underscore.js"></script>
    <script src="Script/Libraries/knockout.js"></script>
    <script src="Script/Libraries/knockout.bindings.afterHtmlRender.js"></script>
    <script src="Script/Libraries/knockout.mapping-2.4.1.js"></script>
    <script src="Script/Libraries/jquery-2.0.0.min.js"></script>
    <script src="Script/Libraries/jquery-ui.min.js"></script>
    <script src="Script/Libraries/queryStringDecoder.js"></script>

    <script src="Settings.js"></script>
    <script src="Script/Init.js"></script>
    <script src="Script/Utils.js"></script>

    <script src="Script/Libraries/Class.js"></script>
    <script src="Script/ViewModels/BaseBuild.js"></script>
    <script src="Script/ViewModels/SingleBuildViewModel.js"></script>
    <script src="Script/ViewModels/MainBuildViewModel.js"></script>
    <script src="Script/ViewModels/BuildScreenViewModel.js"></script>
    <script src="Script/SoundsApi.js"></script>
    <script src="Content/sounds/!List.js"></script>
    <script src="Script/ImagesApi.js"></script>
    <script src="Content/images/!List.js"></script>
</body>
</html>
